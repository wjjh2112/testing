<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Water Quality Monitoring | Accounting - Expenses</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
  <link rel="stylesheet" href="plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
  <!-- Select2 -->
  <link rel="stylesheet" href="plugins/select2/css/select2.min.css">
  <link rel="stylesheet" href="plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="dist/css/adminlte.min.css">
</head>
<body class="hold-transition sidebar-mini layout-fixed">
        <div class="wrapper">
        
          <!-- Preloader -->
          <div class="preloader flex-column justify-content-center align-items-center">
            <img class="animation__shake" src="dist/img/AdminLTELogo.png" alt="Water Quality Monitoring" height="60" width="60">
          </div>
        
        <!-- Navbar -->
        <nav class="main-header navbar navbar-expand navbar-white navbar-light">
          <!-- Left navbar links -->
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
            </li>
            <li>
              <div class="user-panel mt-1 d-flex">
                <div class="image">
                  <img src="dist/img/user2-160x160.jpg" class="img-circle elevation-2" alt="User Image">
                </div>
                <div class="info">
                  <h5 class="d-block">Santubong Viewer</h5>
                </div>
              </div>
            </li>
          </ul>
        
          <!-- Right navbar links -->
          <ul class="navbar-nav ml-auto">
            <!-- Logout Button -->
            <li>
              <button type="button" class="btn btn-block btn-primary">LogOut</button>
            </li>
          </ul>
        </nav>
        <!-- /.navbar -->
        
          <!-- Main Sidebar Container -->
          <aside class="main-sidebar sidebar-dark-primary elevation-4">
            <!-- Brand Logo -->
            <a href="index.html" class="brand-link">
              <div class="row mb-4 justify-content-center">
                <img style="height: 80px; width: auto;" src="SBDLogo.jpeg" >
              </div>
              <div class="row justify-content-center">
                <span class="brand-text">Water Quality Monitoring</span>
              </div>
            </a>
        
        
            <!-- Sidebar -->
            <div class="sidebar">
        
              <!-- Sidebar Menu -->
              <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
                  <!-- Add icons to the links using the .nav-icon class
                       with font-awesome or any other icon font library -->
                  <li class="nav-item">
                    <a href="./index.html" class="nav-link">
                      <i class="nav-icon fas fa-tachometer-alt"></i>
                      <p>
                        Data Telemetry
                      </p>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a href="history.html" class="nav-link">
                      <i class="nav-icon fas fa-book"></i>
                      <p>
                        History
                      </p>
                    </a>
                  </li>
                  <li class="nav-item menu-open">
                    <a href="#" class="nav-link active">
                      <i class="nav-icon fas fa-chart-pie"></i>
                      <p>
                        Accounting
                        <i class="right fas fa-angle-left"></i>
                      </p>
                    </a>
                    <ul class="nav nav-treeview">
                      <li class="nav-item">
                        <a href="accountingExpenses.html" class="nav-link active">
                          <i class="far fa-circle nav-icon"></i>
                          <p>Expenses</p>
                        </a>
                      </li>
                      <li class="nav-item">
                        <a href="accountingIncome.html" class="nav-link">
                          <i class="far fa-circle nav-icon"></i>
                          <p>Income</p>
                        </a>
                      </li>
                    </ul>
                  </li>
                  <li class="nav-item">
                    <a href="gallery.html" class="nav-link">
                      <i class="nav-icon far fa-image"></i>
                      <p>
                        Gallery
                      </p>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a href="about.html" class="nav-link">
                      <i class="nav-icon fas fa-copy"></i>
                      <p>
                        About
                      </p>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a href="settings.html" class="nav-link">
                      <i class="nav-icon fas fa-th"></i>
                      <p>
                        Settings
                      </p>
                    </a>
                  </li>
                </ul>
              </nav>
              <!-- /.sidebar-menu -->
            </div>
            <!-- /.sidebar -->
          </aside>
        
          <!-- Content Wrapper. Contains page content -->
          <div class="content-wrapper">
            <!-- Content Header (Page header) -->
            <div class="content-header">
              <div class="container-fluid">
                <div class="row mb-4">
                  <div class="col">
                    <center><h1 class="m-4">Accounting - Expenses</h1></center>
                  </div><!-- /.col -->
                </div>
                <!-- /.row -->
              </div><!-- /.container-fluid -->
            </div>
            <!-- /.content-header -->
        

<!-- Main content -->
<section class="content">
    <div class="container-fluid">

      <div class="row mb-4 align-items-center">
          <div class="col d-flex justify-content-end">
              <div class="col-2 d-flex">
                  <button type="button" class="btn btn-block btn-primary align-items-center" onclick="window.location.href='addExpensesRecord.html';">
                      &nbsp;Add Expenses Record
                    </button>
              </div>

              <div class="col-3 d-flex ml-3">
                  <button type="button" class="btn btn-block btn-primary align-items-center" onclick="window.location.href='genExpensesRecord.html';">
                      &nbsp;Generate Expenses Record
                    </button>
              </div>
          </div>
      </div>

      <div class="row">
        <div class="col">
          <div class="card">
            <div class="card-header">
              
              <div class="row justify-content-between align-items-center">
                <div class="col">
                  <h3 class="card-title">Expense Records</h3>
                </div>
                <div class="col-2"><br>
                  <div class="form-group">
                    <select id="category-filter" class="form-control select2" style="width: 100%;">
                      <option value="">All Categories</option>
                      <option>Aquaculture Equipment</option>
                      <option>Chemicals and Medications</option>
                      <option>Feed Costs</option>
                      <option>Fertilizers and Lime</option>
                      <option>Purchase of Livestock</option>
                      <option>Repairs and Maintenance</option>
                      <option>Storage and Warehousing</option>
                      <option>Other Expense</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body">
              <table id="expense-table" class="table table-bordered table-striped">
                <thead>
                <tr>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Expense Item</th>
                  <th>Category</th>
                  <th>Remarks</th>
                  <th>View Record</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                  <td>30/01/2024</td>
                  <td>$120</td>
                  <td>Fingerling feed</td>
                  <td>Feed Costs</td>
                  <td>-</td>
                  <td><a href="view_record.html">View</a></td>
                </tr>
                <tr>
                  <td>21/12/2024</td>
                  <td>$150</td>
                  <td>Net</td>
                  <td>Repairs and Maintenance</td>
                  <td>-</td>
                  <td><a href="view_record.html">View</a></td>
                </tr>
                <tr>
                  <td>07/03/2024</td>
                  <td>$500</td>
                  <td>Operational</td>
                  <td>Other Expense</td>
                  <td>-</td>
                  <td><a href="view_record.html">View</a></td>
                </tr>
                <tr>
                  <td>23/02/2024</td>
                  <td>$500</td>
                  <td>Fish graders</td>
                  <td>Other Expense</td>
                  <td>-</td>
                  <td><a href="view_record.php?id=1">View</a></td>
                </tr>
                <tr>
                  <td>06/10/2023</td>
                  <td>$20</td>
                  <td>Fingerlings (small fish)</td>
                  <td>Purchase of Livestock</td>
                  <td>-</td>
                  <td><a href="view_record.php?id=1">View</a></td>
                </tr>
                <tr>
                  <td>17/10/2023</td>
                  <td>$20</td>
                  <td>Fingerlings (small fish)</td>
                  <td>Purchase of Livestock</td>
                  <td>-</td>
                  <td><a href="view_record.php?id=1">View</a></td>
                </tr>
                <tr>
                  <td>04/03/2023</td>
                  <td>$20</td>
                  <td>Fingerlings (small fish)</td>
                  <td>Purchase of Livestock</td>
                  <td>-</td>
                  <td><a href="view_record.php?id=1">View</a></td>
                </tr>
                <tr>
                  <td>14/05/2023</td>
                  <td>$120</td>
                  <td>Fingerling feed</td>
                  <td>Feed Costs</td>
                  <td>-</td>
                  <td><a href="view_record.php?id=1">View</a></td>
                </tr>
                <tr>
                  <td>30/05/2024</td>
                  <td>$120</td>
                  <td>Fingerling feed</td>
                  <td>Feed Costs</td>
                  <td>-</td>
                  <td><a href="view_record.php?id=1">View</a></td>
                </tr>
                <tr>
                  <td>30/09/2023</td>
                  <td>$320</td>
                  <td>Fingerling feed</td>
                  <td>Feed Costs</td>
                  <td>-</td>
                  <td><a href="view_record.php?id=1">View</a></td>
                </tr>
                <tr>
                  <td>30/08/2023</td>
                  <td>$120</td>
                  <td>Fingerling feed</td>
                  <td>Feed Costs</td>
                  <td>-</td>
                  <td><a href="view_record.php?id=1">View</a></td>
                </tr>
                <tr>
                  <td>30/11/2023</td>
                  <td>$390</td>
                  <td>Mainteinance</td>
                  <td>Repairs and Maintenance</td>
                  <td>-</td>
                  <td><a href="view_record.php?id=1">View</a></td>
                </tr>
                <tr>
                  <td>21/12/2023</td>
                  <td>$560</td>
                  <td>Mainteinance</td>
                  <td>Repairs and Maintenance</td>
                  <td>-</td>
                  <td><a href="view_record.php?id=1">View</a></td>
                </tr>
                </tbody>
              </table>
            </div>
            <!-- /.card-body -->
          </div>
          <!-- /.card -->
        </div>
        <!-- /.col -->
      </div>
      <!-- /.row -->
      <div class="row">
        <div class="col-md-6">
            <!-- BAR CHART -->
            <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Expense Analysis</h3><br>
                </div>
                <div class="card-body">
                  <div class="row justify-content-between align-items-center">
                    <button type="button" class="btn btn-primary" id="prevYear" style="left: 10px;">
                      <i class="fas fa-arrow-left"></i>
                    </button>
                    <button type="button" class="btn btn-primary" id="nextYear" style="right: 10px;">
                      <i class="fas fa-arrow-right"></i>
                    </button>
                  </div>
                <div class="chart">
                    <canvas id="barChart" style="min-height: 250px; height: 400px; max-height: 400px; max-width: 100%;"></canvas>
                </div>
              </div>
              <!-- /.card-body -->
          </div>
          <!-- /.card -->
        </div>
      <div class="col-md-6">
          <!-- BAR CHART -->
          <div class="card">
              <div class="card-header">
              <h3 class="card-title">Expense Categories Analysis</h3><br>
              
              </div>
              <div class="card-body">
                <div class="row justify-content-between align-items-center">
                  <button type="button" class="btn btn-primary" id="prevYearPie">
                    <i class="fas fa-arrow-left"></i>
                  </button>
                  <button type="button" class="btn btn-primary" id="nextYearPie">
                    <i class="fas fa-arrow-right"></i>
                  </button>
                </div>
              <div class="chart">
                  <canvas id="pieChart" style="min-height: 250px; height: 400px; max-height: 400px; max-width: 100%;"></canvas>
              </div>
              </div>
              <!-- /.card-body -->
          </div>
          <!-- /.card -->
      </div>
    </div>
    <!-- /.container-fluid -->
  </section>
  <!-- /.content -->
</div>
<!-- Control Sidebar -->
<aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->

<!-- jQuery -->
<script src="plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- Select2 -->
<script src="plugins/select2/js/select2.full.min.js"></script>
<!-- jQuery UI -->
<script src="plugins/jquery-ui/jquery-ui.min.js"></script>

<!-- DataTables  & Plugins -->
<script src="plugins/datatables/jquery.dataTables.min.js"></script>
<script src="plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
<script src="plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
<script src="plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
<script src="plugins/jszip/jszip.min.js"></script>
<script src="plugins/pdfmake/pdfmake.min.js"></script>
<script src="plugins/pdfmake/vfs_fonts.js"></script>
<script src="plugins/datatables-buttons/js/buttons.html5.min.js"></script>
<script src="plugins/datatables-buttons/js/buttons.print.min.js"></script>
<script src="plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
<!-- ChartJS -->
<script src="plugins/chart.js/Chart.min.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/adminlte.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="dist/js/demo.js"></script>

<!-- Data Table Script -->
<script>
    $(function () {
      $("#example1").DataTable({
        "responsive": true, "lengthChange": false, "autoWidth": false,
        "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"],
        "pageLength": 5
      }).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');
      $('#example2').DataTable({
        "paging": true,
        "lengthChange": false,
        "searching": false,
        "ordering": true,
        "info": true,
        "autoWidth": false,
        "responsive": true,
        "pageLength": 5
      });
    });
  </script>

<script>
  $(document).ready(function() {
      // Check if DataTable is already initialized
      if (!$.fn.DataTable.isDataTable('#expense-table')) {
          // Initialize DataTable with sorting on the Date column (index 0)
          var table = $('#expense-table').DataTable({
              "order": [[0, "desc"]],
              "columnDefs": [
                  {
                      "targets": 0,
                      "type": "date-eu"
                  }
              ]
          });

          // Filter table based on category selection
          $('#category-filter').on('change', function() {
              var selectedCategory = $(this).val();
              if (selectedCategory) {
                  table.column(3).search('^' + selectedCategory + '$', true, false).draw();
              } else {
                  table.column(3).search('').draw();
              }
          });
      }
  });

  // Custom date sorting (European format dd/mm/yyyy)
  $.fn.dataTable.ext.type.order['date-eu-pre'] = function(d) {
      var parts = d.split('/');
      return Date.parse(parts[2] + '-' + parts[1] + '-' + parts[0]);
  };

</script>

<!-- Page specific script -->
<script>
  $(function () {
    //Initialize Select2 Elements
    $('.select2').select2()

    //Initialize Select2 Elements
    $('.select2bs4').select2({
      theme: 'bootstrap4'
    })

  })
</script>

<!-- Bar Chart Script -->
<script>
$(function () {
    const ctx = $('#barChart').get(0).getContext('2d');
    let currentYear = new Date().getFullYear();

    const parseExpenseTable = () => {
        const data = {};
        // Parse all rows, not just the displayed ones
        $('#expense-table').DataTable().rows().every(function () {
            const row = $(this.node());
            const amount = parseFloat(row.find('td').eq(1).text().replace('$', '').trim());
            const date = row.find('td').eq(0).text().trim();  // Updated index for date column
            const [day, month, year] = date.split('/').map(Number);

            if (!data[year]) data[year] = Array(12).fill(0);
            data[year][month - 1] += amount;
        });
        return data;
    };

    const expenseData = parseExpenseTable();

    const updateChart = (year) => {
        if (!expenseData[year]) {
            alert(`No data available for ${year}`);
            return;
        }

        const barChartData = {
            labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
            datasets: [{
                label: `Expenses in ${year}`,
                backgroundColor: 'rgba(60,141,188,0.9)',
                borderColor: 'rgba(60,141,188,0.8)',
                data: expenseData[year]
            }]
        };

        if (window.myBarChart) {
            window.myBarChart.destroy();
        }

        window.myBarChart = new Chart(ctx, {
            type: 'bar',
            data: barChartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                title: {
                    display: true,
                    text: `Expenses for ${year}`,
                    fontSize: 18,
                    fontColor: '#333'
                },
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        fontSize: 12,
                        fontColor: '#666'
                    }
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,
                            max: 1000 // Fixed y-axis maximum value
                        }
                    }]
                }
            }
        });
    };

    $('#prevYear').click(() => {
        currentYear--;
        updateChart(currentYear);
    });

    $('#nextYear').click(() => {
        currentYear++;
        updateChart(currentYear);
    });

    updateChart(currentYear);  // Initialize with the current year data
});

</script>

<!-- Pie Chart Script -->
<script>
$(function () {
    const ctxPie = $('#pieChart').get(0).getContext('2d');
    let currentYear = new Date().getFullYear();

    const parseExpenseTable = () => {
        const data = {};

        // Parse all rows, not just the displayed ones
        $('#expense-table').DataTable().rows().every(function () {
            const row = $(this.node());
            const amount = parseFloat(row.find('td').eq(1).text().replace('$', '').trim());
            const date = row.find('td').eq(0).text().trim();  // Updated index for date column
            const category = row.find('td').eq(3).text().trim();  // Updated index for category column
            const [day, month, year] = date.split('/').map(Number);

            if (!data[year]) data[year] = {};
            if (!data[year][category]) data[year][category] = 0;
            data[year][category] += amount;
        });
        return data;
    };

    const expenseData = parseExpenseTable();

    const getYearlyPieData = (year) => {
        const yearlyData = expenseData[year];
        if (!yearlyData) {
            alert(`No data available for ${year}`);
            return null;
        }

        const categories = Object.keys(yearlyData);
        const amounts = categories.map(cat => yearlyData[cat]);

        const pieChartData = {
            labels: categories,
            datasets: [{
                backgroundColor: [
                    '#f56954', '#00a65a', '#f39c12', '#00c0ef', '#3c8dbc',
                    '#d2d6de', '#8a6d3b', '#605ca8', '#78c2ad', '#b66353'
                ],  // Colors for each category
                data: amounts
            }]
        };

        return pieChartData;
    };

    const updatePieChart = (year) => {
        const pieData = getYearlyPieData(year);

        if (!pieData) return;

        if (window.myPieChart) {
            window.myPieChart.destroy();
        }

        window.myPieChart = new Chart(ctxPie, {
            type: 'pie',
            data: pieData,
            options: {
                maintainAspectRatio: false,
                responsive: true,
                title: {
                    display: true,
                    text: `Expenses Categories for ${year}`,
                    fontSize: 18,
                    fontColor: '#333'
                },
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        fontSize: 12,
                        fontColor: '#666'
                    }
                }
            }
        });
    };

    $('#prevYearPie').click(() => {
        currentYear--;
        updatePieChart(currentYear);
    });

    $('#nextYearPie').click(() => {
        currentYear++;
        updatePieChart(currentYear);
    });

    // Initial load with current year data
    updatePieChart(currentYear);
});

</script>

</body>
</html>
